<!DOCTYPE html>

<html>
    <head>
        <link rel="stylesheet" href="./css/index_css.css">
        <link rel="stylesheet" href="./css/booking_css.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
        <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
        <script src="./js/booking.js"></script>
    </head>
    <body>
        <div class="container_whole" id="blur">
        <a class="top_btn" href="#top">
            <i class="fa fa-arrow-up" style="color:#fff; font-size:28px;"></i>
        </a>
        <img src="images/hotel_bg.jpg" id="bg" alt="">
        <div class="container nav_main">
            <nav class="navbar navbar-expand-lg nav_options">
                <div class="navbar-brand hotel_name_nav">robotel</div>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
                    <i class="fa fa-bars" style="color:#fff; font-size:28px;"></i>
                  </span>
                </button>
                <div class="collapse navbar-collapse justify-content-start" id="navbarNavAltMarkup">
                  <div class="navbar-nav ml-auto text-right float-right">
                    <a class="nav-item nav-link" href="index">Home <span class="sr-only">(current)</span></a>
                    <a class="nav-item nav-link" href="rooms">Rooms</a>
                    <a class="nav-item nav-link" href="services">Services</a>
                    <a class="nav-item nav-link" href="#contactus_section">Contact Us</a>
                    
                    
                    <%- include('./partials/account_button.ejs') %>

                </div>
                </div>
              </nav>
        </div>
        <div class="container-fluid px-0 content_con" style="margin-top: 50px;">
            <div class="container-fluid py-5">
                <div class="container booking_form_con">
                  <form id="form_booking" onsubmit="return false;" class="was-validated" autocomplete="off">
                    <div class="row"> 
                        <div class="col-sm-6 px-4">
                            <div class="form-group">
                              <label for="fname">FULL NAME</label>
                              <input type="text" class="form-control" id="fname" name="fname" required>
                              <div class="valid-feedback">
                                <i class="fa fa-check" style="color: darkgreen; font-size:14;"></i>
                              </div>
                              <div class="invalid-feedback">Please fill out this field.</div>
                            </div>
                            <div class="form-group">
                                <label for="email">EMAIL</label>
                                <input type="email" class="form-control" id="email" name="email" value= "<%-_email%>" required readonly >
                                <div class="valid-feedback">
                                  <i class="fa fa-check" style="color: darkgreen; font-size:14;"></i>
                                </div>
                                <div class="invalid-feedback">Please fill out this field.</div>
                              </div>
                              <div class="form-group">
                                <label for="num">CONTACT NUMBER</label>
                                <input type="number" class="form-control" id="num" name="num" required>
                                <div class="valid-feedback">
                                  <i class="fa fa-check" style="color: darkgreen; font-size:14;"></i>
                                </div>
                                <div class="invalid-feedback">Please fill out this field.</div>
                              </div>
                            <div class="form-group">
                              <label for="address">ADDRESS</label>
                              <input type="text" class="form-control" id="address" name="address" required>
                              <div class="valid-feedback">
                                <i class="fa fa-check" style="color: darkgreen; font-size:14;"></i>
                              </div>
                              <div class="invalid-feedback">Please fill out this field.</div>
                            </div>
                        </div>
                        <div class="col-sm-6 px-4 d-flex flex-column justify-content-start">
                          <div>
                            <div class="row">
                              <div class="col">
                                <div class="form-group">
                                  <label for="checkin">CHECK IN</label>
                                  <input id="checkin" class="form-control" readonly="readonly" required/>
                                  <div class="valid-feedback">
                                    <i class="fa fa-check" style="color: darkgreen; font-size:14;"></i>
                                  </div>
                                  <div class="invalid-feedback">Please fill out this field.</div>
                                </div>
                              </div>
                              <div class="col">
                                <div class="form-group">
                                  <label for="checkout">CHECK OUT</label>
                                  <input id="checkout" class="form-control" readonly="readonly" required/>
                                  <div class="valid-feedback">
                                    <i class="fa fa-check" style="color: darkgreen; font-size:14;"></i>
                                  </div>
                                  <div class="invalid-feedback">Please fill out this field.</div>
                                </div>
                              </div>
                            </div>
                            <div class="row">
                              <div class="col">
                                <div class="form-group">
                                  <label for="room">ROOM</label>
                                  <select class="form-control" id="room" required>
                                    <option>Single Room</option>
                                    <option>Double Room</option>
                                    <option>Triple Room</option>
                                    <option>Quad Room</option>
                                    <option>Queen Room</option>
                                    <option>King Room</option>
                                  </select>
                                  <div class="valid-feedback">
                                    <i class="fa fa-check" style="color: darkgreen; font-size:14;"></i>
                                  </div>
                                  <div class="invalid-feedback">Please fill out this field.</div>
                                </div>
                              </div>
                              <div class="col">
                                <div class="form-group">
                                  <label for="guests">GUESTS</label>
                                  <input type="number" class="form-control" id="guests" name="guests" value=1 min=1 max=2 required>
                                  <div class="valid-feedback">
                                    <i class="fa fa-check" style="color: darkgreen; font-size:14;"></i>
                                  </div>
                                  <div class="invalid-feedback">Please fill out this field.</div>
                                </div>
                              </div>
                            </div>
                          </div>                        
                          <div class="row breakdown_con px-5 py-3">
                            <div class="col-sm-12">
                              <div class="row description">
                                <span id="room_type_span" class="col-7 desc_room_type pr-5 d-flex justify-content-end text-right"></span>
                                <span id="room_price_span" class="col-5 price_room_type d-flex justify-content-start"><span>₱</span>0.00</span>
                              </div>
                            </div>
                            <div class="col-sm-12">
                              <div class="row description">
                                <span class="col-7 desc_nights pr-5 d-flex justify-content-end text-right">Number of nights</span>
                                <span id="num_nights_span_1" class="col-5 num_nights d-flex justify-content-start">0</span>
                              </div>
                            </div>
                            <div class="col-sm-12">
                              <div class="row description">
                                <span class="col-7 pr-5 d-flex justify-content-end"></span>
                                <span id="total_price_room_span" class="col-5 total_price_room d-flex justify-content-start"><span>₱</span>0</span>
                              </div>
                            </div>
                            <div class="col-sm-12 pt-3">
                              <div class="row description">
                                <span class="col-7 desc_guests pr-5 d-flex justify-content-end text-right">Additional guest</span>
                                <span id="add_guest_price_span" class="col-5 price_room_type d-flex justify-content-start"><span>₱</span>3,000.00</span>
                              </div>
                            </div>
                            <div class="col-sm-12">
                              <div class="row description">
                                <span class="col-7 desc_num_guests pr-5 d-flex justify-content-end text-right">Number of additional guests</span>
                                <span id="num_add_guest_span" class="col-5 num_guests d-flex justify-content-start">0</span>
                              </div>
                            </div>
                            <div class="col-sm-12">
                              <div class="row description">
                                <span class="col-7 desc_nights pr-5 d-flex justify-content-end text-right">Number of nights</span>
                                <span id="num_nights_span_2" class="col-5 num_nights d-flex justify-content-start">0</span>
                              </div>
                            </div>
                            <div class="col-sm-12">
                              <div class="row description">
                                <span class="col-7 pr-5 d-flex justify-content-end"></span>
                                <span id="total_price_guest_span" class="col-5 total_price_guests d-flex justify-content-start"><span>₱</span>0</span>
                              </div>
                            </div>
                            <div class="col-sm-12 pt-3 px-0">
                              <div class="row description">
                                <span class="col-7 px-0 d-flex justify-content-end"></span>
                                <span class="col-5 px-0 d-flex justify-content-center align-items-center">
                                  <span style="font-size: 17px; font-weight: 500;">₱
                                    <span id="subtotal_span" class="total_price">0</span>
                                  </span>
                                  <div class="col btn_book pl-2 d-flex justify-content-end align-items-center">
                                    <button id="submit_btn" type="submit" class="btn btn_register">BOOK</button>
                                  </div>
                                </span>
                              </div>
                          </div>
                        </div>
                        <p id="booking_error" class="text-danger h6 text-center">Invalid input</p>
                    </div>
                  </form>
                </div>
            </div>
            
        </div>
      </div>
        <%- include('./partials/footer.ejs') %>
    </div>

        <%- include('./partials/account_popup.ejs') %>

        <script type="text/javascript">
          var dates = [];
          $('#booking_error').hide();
          // set default dates
          var start = new Date();
          var defaultDate = new Date(start.getFullYear(), start.getMonth(), start.getDate());
          var checkinDate, checkoutDate, dateDifference, timeDifference;
          // set end date to max one year period:
          var end = new Date(new Date().setYear(start.getFullYear()+1));

          let checkoutdatepicker, checkindatepicker;
          let guests = $('#guests');
          let roomvalue = $('#room');
          let roomNumber = 0;
          let additionalGuest = 3000;
          let numAdditionalGuest;
          let totalPrice, subtotalPrice;
          const maxGuests = [1,2,3,4,2,2];
          const roomprice = [15000, 20000, 25000, 35000, 40000, 45000];

          let roomTypeSpan = $('#room_type_span');;
          let roomPriceSpan = $('#room_price_span');
          let numNightsSpan1 = $('#num_nights_span_1');
          let numNightsSpan2 = $('#num_nights_span_2');
          let totalPriceRoomSpan = $('#total_price_room_span');
          let addGuestPriceSpan = $('#add_guest_price_span');
          let numAddGuestSpan = $('#num_add_guest_span');
          let totalPriceGuestSpan = $('#total_price_guest_span');
          let subtotalSpan = $('#subtotal_span');

          checkoutdatepicker = $('#checkout').datepicker({
                uiLibrary: 'bootstrap4',
                format: 'mm-dd-yyyy',
                todayHighlight: true,
                minDate: defaultDate,
                disableDates: function(date){
                  if(date && dates.indexOf(((date.getMonth() + 1) + "-" + date.getDate() + "-" + date.getFullYear())) > -1){
                    return false;
                  }
                  else{
                    return true;
                  }
                }
              }).on("change", function(){
                updateprice()
              });

          checkindatepicker = $('#checkin').datepicker({
                uiLibrary: 'bootstrap4',
                format: 'mm-dd-yyyy',
                todayHighlight: true,
                minDate: defaultDate,
                disableDates: function(date){
                  if(date && dates.indexOf(((date.getMonth() + 1) + "-" + date.getDate() + "-" + date.getFullYear())) > -1){
                    return false;
                  }
                  else{
                    return true;
                  }
                }
            }).on("change", function(){
              updateprice();
              checkoutdatepicker.datepicker('destroy');
              let tempDate = new Date($(this).val());
              tempDate.setDate(tempDate.getDate() + 1);
              checkoutdatepicker.datepicker({
                uiLibrary: 'bootstrap4',
                format: 'mm-dd-yyyy',
                todayHighlight: true,
                minDate: tempDate,
                disableDates: function(date){
                  if(date && dates.indexOf(((date.getMonth() + 1) + "-" + date.getDate() + "-" + date.getFullYear())) > -1){
                    return false;
                  }
                  else{
                    return true;
                  }
                }
              }).on("change", function(){
                updateprice()
              });
            });

            roomvalue.val(localStorage.getItem("RoomType"));
            initialLoad();

            // guests field
            guests.keypress(function (e){
              e.preventDefault();
            });

            guests.on("change", function(){
              updateprice()
            });
            roomvalue.on("change", function(){
              updateRoomValue();
              guests.val(1);
              updateprice();
              check_available_rooms();
            });

            function check_available_rooms(){
              
              var Room = {
                Type: $('#room').val()
              }
              $.get('check_available_rooms', {Room}, function(result){
                let i;
                dates = [];
                for(i = 0; i < result.length; i++){
                    dates[i] = new Date(result[i]);
                    dates[i] = ((dates[i].getMonth() + 1) + '-' + dates[i].getDate() + '-' + dates[i].getFullYear())
                }
                resetdate();
              });
            }

            function resetdate(){
              checkindatepicker.datepicker('destroy');
              checkindatepicker.datepicker({
                uiLibrary: 'bootstrap4',
                format: 'mm-dd-yyyy',
                todayHighlight: true,
                minDate: defaultDate,
                disableDates: function(date){
                  if(date && dates.indexOf(((date.getMonth() + 1) + "-" + date.getDate() + "-" + date.getFullYear())) > -1){
                    return false;
                  }
                  else{
                    return true;
                  }
                }
              }).on("change", function(){
                updateprice();
                checkoutdatepicker.datepicker('destroy');
                let tempDate = new Date($(this).val());
                tempDate.setDate(tempDate.getDate() + 1);
                checkoutdatepicker.datepicker({
                  uiLibrary: 'bootstrap4',
                  format: 'mm-dd-yyyy',
                  todayHighlight: true,
                  minDate: tempDate,
                  disableDates: function(date){
                  if(date && dates.indexOf(((date.getMonth() + 1) + "-" + date.getDate() + "-" + date.getFullYear())) > -1){
                    return false;
                  }
                  else{
                    return true;
                  }
                }
                }).on("change", function(date){
                  updateprice()
                });
              });

              checkoutdatepicker.datepicker('destroy');
              checkoutdatepicker.datepicker({
                  uiLibrary: 'bootstrap4',
                  format: 'mm-dd-yyyy',
                  todayHighlight: true,
                  minDate: defaultDate,
                  disableDates: function(date){
                  if(date && dates.indexOf(((date.getMonth() + 1) + "-" + date.getDate() + "-" + date.getFullYear())) > -1){
                    return false;
                  }
                  else{
                    return true;
                  }
                }
                }).on("change", function(){
                  updateprice()
                });
            }

            function updateprice(){
              checkinDate = new Date(checkindatepicker.val());
              checkoutDate = new Date(checkoutdatepicker.val());
              timeDifference = Math.abs(checkoutDate - checkinDate);
              dateDifference = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));
              numAdditionalGuest = guests.val() - maxGuests[roomNumber];
              totalPrice =  Math.imul(roomprice[roomNumber], dateDifference);
              subtotalPrice = 0;
              let internationalNumberFormat = new Intl.NumberFormat('en-US');
              if(numAdditionalGuest > 0){
                subtotalPrice = additionalGuest;
                addGuestPriceSpan.text("₱" + (subtotalPrice.toFixed(2)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                numAddGuestSpan.text(numAdditionalGuest);
              }
              else{
                numAddGuestSpan.text("0");
              }
              
              if(checkinDate != "Invalid Date" && checkoutDate != "Invalid Date"){
                numNightsSpan1.text(dateDifference);
                numNightsSpan2.text(dateDifference);
                totalPriceRoomSpan.text("₱" + (totalPrice.toFixed(2)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                totalPriceRoomSpan.val(totalPrice);
                subtotalPrice = subtotalPrice * dateDifference;
                totalPriceGuestSpan.text("₱" + (subtotalPrice.toFixed(2)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                subtotalSpan.text(((totalPrice + subtotalPrice).toFixed(2)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                subtotalSpan.val(totalPrice + subtotalPrice);
              }
              else{
                numNightsSpan1.text("0");
                numNightsSpan2.text("0");
                totalPriceRoomSpan.text("₱0.00");
                totalPriceRoomSpan.val(0);
                totalPriceGuestSpan.text("₱0.00");
                totalPriceGuestSpan.val(0);
                subtotalSpan.text("0.00");
                subtotalSpan.val(0);
              }
            }

            function initialLoad(){
              var Room = {
                Type: $('#room').val()
              }
              $.get('check_available_rooms', {Room}, function(result){
                let i;
                dates = [];
                for(i = 0; i < result.length; i++){
                    dates[i] = new Date(result[i]);
                    dates[i] = ((dates[i].getMonth() + 1) + '-' + dates[i].getDate() + '-' + dates[i].getFullYear())
                }
                resetdate();
                updateRoomValue()
                checkindatepicker.val(localStorage.getItem("Checkin"))
                checkoutdatepicker.val(localStorage.getItem("Checkout"))
                updateprice()
                
                
              });
              
              
            }

            function updateRoomValue(){
              resetdate();
              if(roomvalue.val() == "Single Room"){
                roomNumber = 0;
                additionalGuest = 3000;
                roomTypeSpan.text("Single Room Per Night");
                roomPriceSpan.text("₱15,000.00");
                addGuestPriceSpan.text("₱3,000.00");
                guests.attr({
                  min: 1,
                  max: 2
                });
              }
              else if(roomvalue.val() == "Double Room"){
                roomNumber = 1;
                additionalGuest = 3000;
                roomTypeSpan.text("Double Room Per Night");
                roomPriceSpan.text("₱20,000.00");
                addGuestPriceSpan.text("₱3,000.00");
                guests.attr({
                  min: 1,
                  max: 3
                });
              }
              else if(roomvalue.val() == "Triple Room"){
                roomNumber = 2;
                additionalGuest = 3000;
                roomTypeSpan.text("Triple Room Per Night");
                roomPriceSpan.text("₱25,000.00");
                addGuestPriceSpan.text("₱3,000.00");
                guests.attr({
                  min: 1,
                  max: 4
                });
              }
              else if(roomvalue.val() == "Quad Room"){
                roomNumber = 3;
                additionalGuest = 3000;
                roomTypeSpan.text("Quad Room Per Night");
                roomPriceSpan.text("₱35,000.00");
                addGuestPriceSpan.text("₱3,000.00");
                guests.attr({
                  min: 1,
                  max: 5
                });
              }
              else if(roomvalue.val() == "Queen Room"){
                roomNumber = 4;
                additionalGuest = 5000;
                roomTypeSpan.text("Queen Room Per Night");
                roomPriceSpan.text("₱40,000.00");
                addGuestPriceSpan.text("₱5,000.00");
                guests.attr({
                  min: 1,
                  max: 4
                });
              }
              else if(roomvalue.val() == "King Room"){
                roomNumber = 5;
                additionalGuest = 5000;
                roomTypeSpan.text("King Room Per Night");
                roomPriceSpan.text("₱45,000.00");
                addGuestPriceSpan.text("₱5,000.00");
                guests.attr({
                  min: 1,
                  max: 4
                });
              }
            }

        </script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script type="text/javascript">
            function toggle(){
                var blur = document.getElementById('blur');
                blur.classList.toggle('active');
                var popup = document.getElementById('popup');
                popup.classList.toggle('active');

                $("#form_login").show();
                $("#form_createaccount").hide();
                $("#login_error").hide();
                $("#register_error").hide();
            }
            function create_acc() {
                $("#form_login").hide();
                $("#form_createaccount").show();
                $("#register_error").hide();
            }
            function login() {
                $("#form_login").show();
                $("#form_createaccount").hide();
                $("#login_error").hide();
            }

            function success_book(){
              window.location.href = '/';
            }
            
        </script>
    </body>
</html>